<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <meta name="app-mobile-app-capable" content="yes">
  <meta name="app-mobile-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <title>文章</title>
  <link rel="shortcut icon" href="../images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="../styles/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="../styles/github-markdown.css">
  <link rel="stylesheet" type="text/css" href="../scripts/lib/high-light/styles/github.css">
  <link rel="stylesheet" type="text/css" href="../scripts/lib/editor/editor.css">
  <link rel="stylesheet" type="text/css" href="../styles/frame.css">
  <link rel="stylesheet" type="text/css" href="../styles/override.css">
  <link rel="stylesheet" type="text/css" href="../styles/article.css">
  <link rel="stylesheet" type="text/css" href="../styles/mobile.css">
</head>
<body>
<header class="frame-header">
  <div class="frame-wrapper">
    <div class="header-left">
      <a class="logo" href="#"><img src="../images/logo.png"></a>
      <nav>
        <a href="#">首页</a>
        <a href="#">资源</a>
      </nav>
    </div>
    <div class="header-right">
      <form class="search">
        <input type="search" placeholder="请输入关键字">
        <a class="btn btn-search" href="javascript:;"><i class="fa fa-search"></i></a>
      </form>
      <nav>
        <a href="#">注册</a>
        <a href="#">登录</a>
        <a href="#">发布话题</a>
        <a href="#">未读消息<i class="icon icon-red-dot"></i></a>
        <a href="#">admin</a>
        <a href="#">退出</a>
      </nav>
    </div>
  </div>
</header>
<header class="m-frame-header">
  <a href="javascript:;" class="btn btn-menu" id="m-btn-menu"><i class="fa fa-navicon"></i></a>
  <div class="box-btns">
    <!--<a class="btn" href="#">注册</a>-->
    <!--<a class="btn" href="#">登录</a>-->
    <a class="btn" href="#">未读消息 <i class="icon icon-red-dot"></i></a>
    <a class="btn" href="#">发布话题</a>
  </div>
  <div class="title">
    <a href="#"><img src="../images/logo_short.png"></a>
  </div>
</header>
<div class="m-nav-bg" id="m-nav-bg"></div>
<nav class="m-nav" id="m-nav">
  <a href="#"><span class="icon"><i class="fa fa-home"></i></span> 首页</a>
  <a href="#"><span class="icon"><i class="fa fa-file-text"></i></span> 资料</a>
  <a href="#"><span class="icon"><i class="fa fa-user-circle"></i></span> 用户中心</a>
  <a href="＃"><span class="icon"><i class="fa fa-sign-out"></i></span> 退出</a>
</nav>
<section class="frame-content">
  <div class="frame-wrapper">

    <div class="m-search">
      <form class="search">
        <input type="search" placeholder="请输入关键字">
        <a class="btn btn-search" href="javascript:;"><i class="fa fa-search"></i></a>
      </form>
    </div>

    <div class="block-main">
      <div class="panel">
        <article class="article">
          <div class="article-header">
            <div class="title">
              <span class="tag">讨论</span>
              <h3>测试请发到客户端测试专区，违规影响用户的，直接封号</h3>
            </div>
            <div class="info">
              <span class="item">• 版块 [讨论]</span>
              <span class="item">• 作者 <a href="#">admin</a></span>
              <span class="item">• 发布于 <span class="date">2017-09-18</span></span>
              <span class="item">• 最后一次编辑 3个月前</span>
              <span class="item">• 11个回复</span>
              <span class="item">• 728次浏览</span>
            </div>
            <div class="operator">
              <div>
                <span class="btn"><i class="fa fa-edit"></i>编辑</span>
                <span class="btn"><i class="fa fa-trash"></i>删除</span>
                <!--<span class="btn"><i class="fa fa-star-o"></i>收藏</span>-->
                <span class="btn"><i class="fa fa-star"></i>已收藏</span>
                <!--<span class="btn"><i class="fa fa-thumbs-o-up"></i>点赞</span>-->
                <span class="btn"><i class="fa fa-thumbs-up"></i>已点赞<span class="num">111</span></span>
              </div>
            </div>
          </div>
          <div class="article-content">
            <div class="markdown-body">
              <div class="markdown-text"><h2>koa</h2>
                <blockquote>
                  <p><code>koa</code>是由<code>express</code>原班人马打造的一个更小、更富有表现力、更健壮的<code>web</code>框架。</p>
                </blockquote>
                <p>在我眼中，<code>koa</code>的确是比<code>express</code>轻量的多，<code>koa</code>给我的感觉更像是一个中间件框架，<code>koa</code>只是一个基础的架子，需要用到的相应的功能时，用相应的中间件来实现就好，诸如路由系统等。一个更好的点在于，<code>express</code>是基于回调来处理，至于回调到底有多么的不好，大家可以自行搜索来看。<code>koa1</code>基于的<code>co</code>库，所以<code>koa1</code>利用<code>Generator</code>来代替回调，而<code>koa2</code>由于<code>node</code>对<code>async/await</code>的支持，所以<code>koa2</code>利用的是<code>async/await</code>。关于<code>async</code>以及<code>co</code>库等，大家可以参考我之前写过的一篇文章（<a href="https://segmentfault.com/a/1190000008687414">理解async</a>）。<code>koa</code>可以说是一个各种中间件的架子，下面就来看一下<code>koa</code>对于中间件部分的实现：</p>
                <h2>koa1的中间件</h2>
                <p><code>koa1</code>主要利用的是<code>Generator</code>来实现，一般来说，<code>koa1</code>的一个中间件大概是长这个样子的：</p>
                <pre class="prettyprint"><code>app.use(function *(next){
    console.log(1);
    yield next;
    console.log(5);
});
app.use(function *(next){
    console.log(2);
    yield next;
    console.log(4);
});
app.use(function *(){
    console.log(3);
});
</code></pre><p>这样的输出会是<code>1, 2, 3, 4, 5</code>，<code>koa</code>的中间件的实现主要依靠的是<code>koa-compose</code>：</p>
                <pre class="prettyprint language-js"><code>function compose(middleware){
  return function *(next){
    if (!next) next = noop();

    var i = middleware.length;
    &#x2F;&#x2F; 组合中间件
    while (i--) {
      next = middleware[i].call(this, next);
    }

    return yield *next;
  }
}
function *noop(){}
</code></pre><p>源码非常的简单，实现的功能就是将所有的中间件串联起来，首先给倒数第一个中间件传入一个<code>noop</code>作为其<code>next</code>，再将这个整理后的倒数第一个中间作为<code>next</code>传入倒数第二个中间件，最终得到的<code>next</code>就是整理后的第一个中间件。说起来比较复杂，画图来看：</p>
                <p><img src="//dn-cnode.qbox.me/FqqHNh4U_H76zKWB2VVPeaFvbcIX" alt="87399421-58faf1241df42_articlex.png"></p>
                <p>实现的效果如同上图，与<code>redux</code>需要实现的目标类似，只要遇到了<code>yield next</code>就去执行下一个中间件，利用<code>co</code>库很容易将这个流程串联起来，下面来简单模拟下，中间件完整的实现：</p>
                <pre class="prettyprint"><code>const middlewares = [];

const getTestMiddWare = (loggerA, loggerB) =&gt; {
    return function *(next) {
        console.log(loggerA);
        yield next;
        console.log(loggerB);
    }
};
const mid1 = getTestMiddWare(1, 4),
    mid2 = getTestMiddWare(2, 3);

const getData = new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; resolve(&#x27;数据已经取出&#x27;), 1000);
});

function *response(next) {
    &#x2F;&#x2F; 模拟异步读取数据库数据
    const data = yield getData;
    console.log(data);
}

middlewares.push(mid1, mid2, response);
&#x2F;&#x2F; 简单模拟co库
function co(gen) {
    const ctx = this,
        args = Array.prototype.slice.call(arguments, 1);
    return new Promise((reslove, reject) =&gt; {
        if (typeof gen === &#x27;function&#x27;) gen = gen.apply(ctx, args);
        if (!gen || typeof gen.next !== &#x27;function&#x27;) return resolve(gen);

        const baseHandle = handle =&gt; res =&gt; {
            let ret;
            try {
                ret = gen[handle](res);
            } catch(e) {
                reject(e);
            }
            next(ret);
        };
        const onFulfilled = baseHandle(&#x27;next&#x27;),
            onRejected = baseHandle(&#x27;throw&#x27;);

        onFulfilled();
        function next(ret) {
            if (ret.done) return reslove(ret.value);
            &#x2F;&#x2F; 将yield的返回值转换为Proimse
            let value = null;
            if (typeof ret.value.then !== &#x27;function&#x27;) {
                value = co(ret.value);
            } else {
                value = ret.value;
            }
            if (value) return value.then(onFulfilled, onRejected);
            return onRejected(new TypeError(&#x27;yield type error&#x27;));
        }
    });
}
&#x2F;&#x2F; 调用方式
const gen = compose(middlewares);
co(gen);
</code></pre><h2>koa2的中间件</h2>
                <p>随着<code>node</code>对于<code>async/await</code>的支持，貌似不需要再借助于<code>co</code>这种工具库了，直接利用原生的就好，于是<code>koa</code>也做出了改变，来看目前的<code>koa-compose</code>：</p>
                <pre class="prettyprint"><code>function compose (middleware) {
  &#x2F;&#x2F; 参数检验
  return function (context, next) {
    &#x2F;&#x2F; last called middleware #
    let index = -1
    return dispatch(0)
    function dispatch (i) {
      if (i &lt;= index) return Promise.reject(new Error(&#x27;next() called multiple times&#x27;))
      index = i
      let fn = middleware[i]
      &#x2F;&#x2F; 最后一个中间件的调用
      if (i === middleware.length) fn = next
      if (!fn) return Promise.resolve()
      &#x2F;&#x2F; 用Promise包裹中间件，方便await调用
      try {
        return Promise.resolve(fn(context, function next () {
          return dispatch(i + 1)
        }))
      } catch (err) {
        return Promise.reject(err)
      }
    }
  }
}
</code></pre><p><code>koa-compose</code>利用了<code>Promise</code>，<code>koa2</code>的中间件的参数也有一个变为了两个，而且执行下一个的中间件利用的是<code>await next()</code>，要达到与上面的示例代码的相同效果，需要更改中间件的写法：</p>
                <pre class="prettyprint"><code>const middlewares = [];
const getTestMiddWare = (loggerA, loggerB) =&gt; async (ctx, next) =&gt; {
    console.log(loggerA);
    await next();
    console.log(loggerB);
};

const mid1 = getTestMiddWare(1, 4),
    mid2 = getTestMiddWare(2, 3);
const response = async () =&gt; {
    &#x2F;&#x2F; 模拟异步读取数据库数据
    const data = await getData();
    console.log(data);
};
const getData = () =&gt; new Promise((resolve, reject) =&gt; {
    setTimeout(() =&gt; resolve(&#x27;数据已经取出&#x27;), 1000);
});
middlewares.push(mid1, mid2);

&#x2F;&#x2F; 调用方式
compose(middlewares)(null, response);
</code></pre><h2>如何做到兼容</h2>
                <p>可以看到的是，<code>koa1</code>与<code>koa2</code>对于中间件的实现还是有着很多的不同的，将<code>koa1</code>的中间件直接拿到<code>koa2</code>下面来使用肯定是会出现错误的，如何兼容这两个版本也成了一个问题，<code>koa</code>团队写了一个包来是<code>koa1</code>的中间件可以用于<code>koa2</code>中，叫做<code>koa-convert</code>，先来看看这个包怎么使用：</p>
                <pre class="prettyprint"><code>function *mid3(next) {
    console.log(2, &#x27;koa1的中间件&#x27;);
    yield next;
    console.log(3, &#x27;koa1的中间件&#x27;);
}
convert.compose(mid3)
</code></pre><p>来看下这个包实现的思路：</p>
                <pre class="prettyprint"><code>&#x2F;&#x2F; 将参数转为数组，对每一个koa1的中间件执行convert操作
convert.compose = function (arr) {
  if (!Array.isArray(arr)) {
    arr = Array.from(arguments)
  }
  return compose(arr.map(convert))
}
&#x2F;&#x2F; 关键在于convert的实现
const convert = mw =&gt; (ctx, next) =&gt; {
    &#x2F;&#x2F; 借助co库，返回一个Promise，同时执行yield
    return co.call(ctx, mw.call(ctx, createGenerator(next)));
};

function * createGenerator (next) {
  &#x2F;*
     next为koa-compomse中：
     function next () {
         return dispatch(i + 1)
     }
  *&#x2F;
  return yield next()
  &#x2F;&#x2F; 执行完koa1的中间件，又回到了利用await执行koa2中间件的正轨
}
</code></pre><p>个人感觉<code>koa-convert</code>的思路就是对<code>Generator</code>封装一层<code>Promise</code>，使上一个中间件可以利用<code>await next()</code>的方式调用，对于<code>Generator</code>的执行，利用<code>co</code>库，从而达到了兼容的目的。</p>
              </div>

            </div>
          </div>
        </article>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="title"><span>222</span> 条回复</div>
        </div>
        <div class="panel-content">
          <div class="comment">
            <div class="avatar">
              <a href="#"><img src="../images/avatar.png"></a>
            </div>
            <div class="info">
              <dl>
                <dt>
                <div class="comment-info">
                  <a href="#" class="username">admin</a> • 1楼 • 2年前 • <span class="tag">作者</span>
                </div>
                <div class="operator">
                  <span class="btn"><i class="fa fa-edit"></i> 编辑</span>
                  <span class="btn"><i class="fa fa-trash"></i> 删除</span>
                </div>
                </dt>
                <dd>
                  <div class="markdown-body">
                    <a href="#">@yyl</a> 非常感谢
                    <pre>
                      var a = 'a';
                      var b = 'b';
                    </pre>
                  </div>
                </dd>
              </dl>
            </div>
          </div>

          <div class="comment">
            <div class="avatar">
              <a href="#"><img src="../images/avatar.png"></a>
            </div>
            <div class="info">
              <dl>
                <dt>
                <div class="comment-info">
                  <a href="#" class="username">admin</a> • 1楼 • 2年前 • <span class="tag">作者</span>
                </div>
                <div class="operator">
                  <span class="btn"><i class="fa fa-edit"></i> 编辑</span>
                  <span class="btn"><i class="fa fa-trash"></i> 删除</span>
                </div>
                </dt>
                <dd>
                  <div class="markdown-body">
                    <a href="#">@yyl</a> 非常感谢
                  </div>
                </dd>
              </dl>
            </div>
          </div>

          <div class="comment">
            <div class="avatar">
              <a href="#"><img src="../images/avatar.png"></a>
            </div>
            <div class="info">
              <dl>
                <dt>
                <div class="comment-info">
                  <a href="#" class="username">admin</a> • 1楼 • 2年前 • <span class="tag">作者</span>
                </div>
                <div class="operator">
                  <span class="btn"><i class="fa fa-edit"></i> 编辑</span>
                  <span class="btn"><i class="fa fa-trash"></i> 删除</span>
                </div>
                </dt>
                <dd>
                  <div class="markdown-body">
                    <a href="#">@yyl</a> 非常感谢
                  </div>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div class="title">添加回复</div>
        </div>
        <div class="panel-content">
          <div class="editor-wrapper">
            <div class="editor-wrapper-inner">
              <textarea class="editor"></textarea>
            </div>
            <div class="btn-line">
              <span class="btn btn-primary" id="btn-submit">回复</span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <aside class="block-aside">
      <div class="panel">
        <div class="panel-header">
          <h4>作者信息</h4>
        </div>
        <div class="panel-content">
          <div class="user-card">
            <div>
              <a href="#" class="avatar"><img src="../images/avatar.png"></a>
              <div class="username-box">
                <a href="#" class="username">admin</a>
              </div>
            </div>
            <div class="signature">“ 这家伙很懒，什么个性签名都没有留下。 ”</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h4>作者其它话题</h4>
        </div>
        <div class="panel-content">
          <ul class="info-list limit-text">
            <li><a href="https://ruby-china.org">这是作者的另一个话题</a></li>
            <li><a href="https://ruby-china.org">这是作者的另一个话题</a></li>
            <li><a href="https://ruby-china.org">这是作者的另一个话题</a></li>
            <li><a href="https://ruby-china.org">这是作者的另一个话题</a></li>
            <li><a href="https://ruby-china.org">这是作者的另一个话题</a></li>
          </ul>
        </div>
      </div>

      <div class="panel friendly-link">
        <div class="panel-header">
          <h4>友情社区</h4>
        </div>
        <div class="panel-content">
          <ul class="info-list">
            <li><a href="https://ruby-china.org" rel="nofollow" target="_blank"><img src="../images/friendly/ruby.png"></a>
            </li>
            <li><a href="https://cnodejs.org" rel="nofollow" target="_blank"><img
                src="../images/friendly/cnode.png"></a></li>
            <li><a href="https://gocn.io" rel="nofollow" target="_blank"><img src="../images/friendly/gocn.png"></a>
            </li>
          </ul>
        </div>
      </div>

      <div class="panel statistics-info">
        <div class="panel-header">
          <h4>统计信息</h4>
        </div>
        <div class="panel-content">
          <ul class="info-list">
            <li>社区会员: 3227 人</li>
            <li>帖子数: 34090 个</li>
            <li>回帖数: 330130 条</li>
          </ul>
        </div>
      </div>
    </aside>

  </div>
</section>
<footer class="frame-footer">
  <div class="frame-wrapper">
    <div class="links">
      <a href="#" target="_blank">关于本站</a>
      <a href="https://github.com/yinyanlv/runner" target="_blank" rel="nofollow">本站源码地址</a>
      <a href="#" target="_blank">RSS</a>
    </div>
    <div class="site-info">由众多 Rust 爱好者共同构建的 Rust 中文社区，致力于 Rust 的技术研究与发展。</div>
  </div>
</footer>

<div class="back-to-top">
  回到顶部
</div>

<!--<div class="dialog-bg"></div>-->
<!--<div class="dialog-wrapper">-->
  <!--<div class="dialog-header">上传图片<span class="btn"><i class="fa fa-close"></i></span></div>-->
  <!--<div class="dialog-content">-->
    <!--<form id="form-upload">-->
      <!--<input type="file" name="files" id="input-files" multiple>-->
    <!--</form>-->
    <!--<div class="btn-line">-->
      <!--<span class="btn btn-primary" id="btn-select-files">选择文件</span>-->
      <!--<span class="btn btn-primary" id="btn-upload">上传</span>-->
    <!--</div>-->
    <!--<div class="file-list">-->
      <!--<div class="file"><div class="filename">这里是文件名</div><span class="btn btn-delete-file"><i class="fa fa-trash"></i></span></div>-->
      <!--<div class="file"><div class="filename">这里是文件名</div><span class="btn btn-delete-file"><i class="fa fa-trash"></i></span></div>-->
      <!--<div class="file"><div class="filename">这里是文件名</div><span class="btn btn-delete-file"><i class="fa fa-trash"></i></span></div>-->
      <!--<div class="file"><div class="filename">这里是文件名</div><span class="btn btn-delete-file"><i class="fa fa-trash"></i></span></div>-->
      <!--<div class="file"><div class="filename">这里是文件名</div><span class="btn btn-delete-file"><i class="fa fa-trash"></i></span></div>-->
    <!--</div>-->
  <!--</div>-->
<!--</div>-->
<script type="text/javascript" src="../scripts/lib/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../scripts/lib/jquery.form.min.js"></script>
<script type="text/javascript" src="../scripts/lib/high-light/highlight.pack.js"></script>
<script type="text/javascript" src="../scripts/app/uploader.js"></script>
<script type="text/javascript" src="../scripts/lib/editor/editor.js"></script>
<script type="text/javascript" src="../scripts/lib/markdown-it.min.js"></script>
<script type="text/javascript" src="../scripts/app/mount-editor.js"></script>
<script type="text/javascript" src="../scripts/app/frame.js"></script>
<script type="text/javascript" src="../scripts/app/article.js"></script>
</body>
</html>